hljs = require('highlight.js');

module.exports = exports = function (jadeLang, jadeRuntime, jadeFilters) {
  var sampleIndex = 0;

  var template = [
    '.example!= sample',
    '.highlight',
    '  pre.highlight__listing.hljs: code(class=lang)!= htmlSource'
  ].join('\n');

  return function (text, options) {
    sampleIndex++;

    var sample = jadeLang.render(text, {
      pretty: true
    });

    var sampleNonPretty = jadeLang.render(text, {
      pretty: false
    });

    // Remove first empty line generated by Jade
    sample = sample.replace(/^\n/g, '');

    // enforce HTML syntax
    hljs.configure({
      languages: ['html']
    });

    var htmlSource = jadeFilters('highlight', sample);

    // undo global hljs configs
    hljs.configure({
      languages: null
    });

    return jadeLang.render(template, {
      pretty: true,
      index: sampleIndex,
      sample: sampleNonPretty,
      htmlSource: htmlSource,
      lang: options.lang
    });
  };
};
